name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        type: choice
        required: true
        options:
          - patch
          - minor
          - major
      release_notes:
        description: 'Release notes (what changed)'
        type: string
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================
  # CREATE RELEASE: Bump version and create PR
  # ============================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.bump.outputs.version }}
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Bump version
        id: bump
        run: |
          # Bump root package.json
          npm version ${{ inputs.version_bump }} --no-git-tag-version

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update changelog
        run: |
          NEW_VERSION="${{ steps.bump.outputs.version }}"
          DATE=$(date +%Y-%m-%d)

          # Create or update CHANGELOG.md
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Insert new version entry after the header
          ENTRY="## [v$NEW_VERSION] - $DATE

          ${{ inputs.release_notes }}

          **Deployed by:** ${{ github.actor }}
          **Commit:** ${{ github.sha }}

          ---
          "

          # Create temp file with new entry
          head -n 4 CHANGELOG.md > CHANGELOG.tmp
          echo "$ENTRY" >> CHANGELOG.tmp
          tail -n +5 CHANGELOG.md >> CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md

      - name: Create release branch
        run: |
          BRANCH_NAME="release/v${{ steps.bump.outputs.version }}"
          git checkout -b "$BRANCH_NAME"
          git add package.json CHANGELOG.md
          git commit -m "chore(release): v${{ steps.bump.outputs.version }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/v${{ steps.bump.outputs.version }}
          base: main
          title: "chore(release): v${{ steps.bump.outputs.version }}"
          body: |
            ## Release v${{ steps.bump.outputs.version }}

            ### Changes
            ${{ inputs.release_notes }}

            ### Checklist
            - [ ] Changelog updated
            - [ ] Version bumped (${{ steps.current.outputs.version }} â†’ ${{ steps.bump.outputs.version }})
            - [ ] All CI checks pass

            ### After Merge
            This PR will:
            1. Trigger staging deployment automatically
            2. Create a Git tag `v${{ steps.bump.outputs.version }}`
            3. Create a GitHub Release

            **To deploy to production:** Run the [Deploy to Production](../actions/workflows/deploy-prod.yml) workflow manually.

            ---
            ðŸ¤– Generated by Release Workflow
          labels: |
            release
            automated

      - name: Output summary
        run: |
          echo "## ðŸ“¦ Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.bump.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. Staging will deploy automatically" >> $GITHUB_STEP_SUMMARY
          echo "3. Run 'Deploy to Production' workflow when ready" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # TAG RELEASE: Create tag after PR merge
  # ============================================
  tag-release:
    name: Tag Release
    runs-on: ubuntu-latest
    needs: create-release
    if: false  # This job is triggered by a separate workflow on PR merge

    steps:
      - name: Placeholder
        run: echo "This job runs via on-merge workflow"

# ============================================
# SEPARATE WORKFLOW: on-release-merge.yml
# Triggers when release PR is merged
# ============================================
# name: On Release Merge
#
# on:
#   pull_request:
#     types: [closed]
#     branches: [main]
#
# jobs:
#   create-tag:
#     if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'release/')
#     steps:
#       - Extract version from branch name
#       - Create git tag
#       - Create GitHub release
