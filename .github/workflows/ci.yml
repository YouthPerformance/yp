name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # Uses version from package.json packageManager field

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm turbo run typecheck
        continue-on-error: true  # Known issues in yp-alpha - TODO: fix and remove

      - name: Lint
        run: pnpm turbo run lint
        continue-on-error: true  # Don't fail on lint for now

      - name: Build
        run: pnpm turbo run build
        continue-on-error: true  # web-academy needs CONVEX_URL secret - TODO: add to GitHub secrets

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for secrets in client code
        run: |
          echo "Scanning for exposed secrets in client-side code..."

          # Check for common secret patterns in client-side code
          # Excludes: app/api/ (server-side), server/, routes with .server.
          SECRETS_FOUND=0

          # Scan components for secret patterns (these should never have secrets)
          if grep -rn "SHOPIFY_ADMIN_TOKEN\|PRIVATE_.*_TOKEN" \
            --include="*.tsx" --include="*.ts" --include="*.jsx" --include="*.js" \
            apps/*/src/components/ apps/*/app/components/ 2>/dev/null; then
            echo "::error::Secrets found in component files!"
            SECRETS_FOUND=1
          fi

          # Check for hardcoded API keys (actual key values, not env references)
          if grep -rn "sk-[a-zA-Z0-9]\{20,\}\|shpat_[a-zA-Z0-9]\{20,\}" \
            --include="*.tsx" --include="*.ts" --include="*.jsx" --include="*.js" \
            apps/ packages/ 2>/dev/null | grep -v ".env" | grep -v "node_modules" | grep -v "app/api/"; then
            echo "::error::Potential hardcoded API keys found!"
            SECRETS_FOUND=1
          fi

          if [ $SECRETS_FOUND -eq 1 ]; then
            exit 1
          fi

          echo "âœ… No secrets found in client-side code"

  # Uncomment when tests are added
  # test:
  #   name: Test
  #   runs-on: ubuntu-latest
  #   needs: validate
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #         cache: 'pnpm'
  #
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #
  #     - name: Run tests
  #       run: pnpm turbo run test
