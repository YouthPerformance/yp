---
import BaseLayout from "./BaseLayout.astro";
import Header from "../components/layout/Header.astro";
import Footer from "../components/layout/Footer.astro";
import Breadcrumb from "../components/layout/Breadcrumb.astro";
import ArticleSchema from "../components/seo/ArticleSchema.astro";
import FAQSchema from "../components/seo/FAQSchema.astro";
import DirectAnswer from "../components/content/DirectAnswer.astro";
import KeyTakeaways from "../components/content/KeyTakeaways.astro";
import ExpertBox from "../components/content/ExpertBox.astro";

interface Props {
  frontmatter: {
    title: string;
    description: string;
    author: string;
    publishedDate: Date;
    updatedDate: Date;
    readTime: string;
    directAnswer: string;
    keyTakeaways: string[];
    category: string;
    keywords: string[];
    canonical: string;
    programBadge?: string;
  };
  authorData: {
    name: string;
    initials: string;
    tagline?: string;
    credentials: string[];
    socialLinks?: {
      instagram?: string;
      twitter?: string;
      wikipedia?: string;
    };
  };
  breadcrumbs: { label: string; url?: string }[];
  faqs?: { question: string; answer: string }[];
  toc?: { id: string; label: string }[];
}

const { frontmatter, authorData, breadcrumbs, faqs = [], toc = [] } = Astro.props;

const {
  title,
  description,
  publishedDate,
  updatedDate,
  readTime,
  directAnswer,
  keyTakeaways,
  keywords,
  canonical,
  programBadge,
} = frontmatter;

// Build credentials string
const credentialsStr = authorData.credentials.join(" • ");

// Build social links for schema
const sameAs = [
  authorData.socialLinks?.instagram,
  authorData.socialLinks?.twitter,
  authorData.socialLinks?.wikipedia,
].filter(Boolean) as string[];
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  author={authorData.name}
  publishedDate={publishedDate}
  updatedDate={updatedDate}
  keywords={keywords}
>
  <Fragment slot="head">
    <ArticleSchema
      title={title}
      description={description}
      author={{
        name: authorData.name,
        jobTitle: authorData.credentials[0],
        description: credentialsStr,
        sameAs,
      }}
      publishedDate={publishedDate}
      updatedDate={updatedDate}
      keywords={keywords}
      canonical={canonical}
    />
    {faqs.length > 0 && <FAQSchema faqs={faqs} />}
  </Fragment>

  <Header />
  <Breadcrumb items={breadcrumbs} />

  <!-- Hero Section -->
  <header class="hero-section px-3 py-6 pb-4 relative" style="background: var(--gradient-dark);">
    <!-- Top gradient line -->
    <div class="absolute top-0 left-0 right-0 h-0.5" style="background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-gold) 50%, var(--accent-primary) 100%);"></div>

    <div class="container-article">
      {programBadge && (
        <span class="inline-block px-2 py-1 rounded-full font-mono text-label uppercase tracking-widest mb-2" style="background-color: var(--accent-primary); color: var(--bg-primary);">
          {programBadge}
        </span>
      )}

      <h1 class="font-bebas text-display-lg leading-tight mb-2" style="color: var(--text-primary);">
        {title}
      </h1>

      <div class="flex flex-wrap gap-2 items-center text-body-sm mb-3" style="color: var(--text-muted);">
        <time datetime={updatedDate.toISOString()}>
          Updated {updatedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
        </time>
        <span>•</span>
        <span>{readTime}</span>
        <span>•</span>
        <span>Expert Reviewed</span>
      </div>

      <!-- Direct Answer -->
      <DirectAnswer>
        <p set:html={directAnswer} />
      </DirectAnswer>

      <!-- Key Takeaways -->
      <KeyTakeaways takeaways={keyTakeaways} />

      <!-- Expert Box -->
      <ExpertBox
        name={authorData.name}
        initials={authorData.initials}
        tagline={authorData.tagline}
        credentials={credentialsStr}
      />
    </div>
  </header>

  <!-- Table of Contents -->
  {toc.length > 0 && (
    <div class="container-article">
      <nav class="p-3 rounded-lg my-4" aria-label="Table of Contents" style="background-color: var(--bg-tertiary);">
        <h2 class="font-bebas text-display-xs mb-2" style="color: var(--text-primary);">In This Guide</h2>
        <ol class="pl-3 space-y-1">
          {toc.map((item) => (
            <li class="text-body-sm">
              <a href={`#${item.id}`} class="hover:underline" style="color: var(--accent-primary);">{item.label}</a>
            </li>
          ))}
        </ol>
      </nav>
    </div>
  )}

  <!-- Main Content -->
  <main class="py-4">
    <div class="container-article prose prose-lg max-w-none">
      <slot />
    </div>
  </main>

  <Footer />
</BaseLayout>
