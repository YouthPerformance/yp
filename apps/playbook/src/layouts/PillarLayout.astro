---
import BaseLayout from "./BaseLayout.astro";
import Header from "../components/layout/Header.astro";
import Footer from "../components/layout/Footer.astro";
import Breadcrumb from "../components/layout/Breadcrumb.astro";
import ArticleSchema from "../components/seo/ArticleSchema.astro";
import FAQSchema from "../components/seo/FAQSchema.astro";
import DirectAnswer from "../components/content/DirectAnswer.astro";
import KeyTakeaways from "../components/content/KeyTakeaways.astro";
import ExpertBox from "../components/content/ExpertBox.astro";

interface Props {
  frontmatter: {
    title: string;
    description: string;
    author: string;
    publishedDate: Date;
    updatedDate: Date;
    readTime: string;
    directAnswer: string;
    keyTakeaways: string[];
    category: string;
    keywords: string[];
    canonical: string;
    programBadge?: string;
  };
  authorData: {
    name: string;
    initials: string;
    tagline?: string;
    credentials: string[];
    image?: string;
    profileUrl?: string;
    socialLinks?: {
      instagram?: string;
      twitter?: string;
      wikipedia?: string;
    };
  };
  breadcrumbs: { label: string; url?: string }[];
  faqs?: { question: string; answer: string }[];
  toc?: { id: string; label: string }[];
}

const { frontmatter, authorData, breadcrumbs, faqs = [], toc = [] } = Astro.props;

const {
  title,
  description,
  publishedDate,
  updatedDate,
  readTime,
  directAnswer,
  keyTakeaways,
  keywords,
  canonical,
  programBadge,
} = frontmatter;

// Build credentials string
const credentialsStr = authorData.credentials.join(" • ");

// Build social links for schema
const sameAs = [
  authorData.socialLinks?.instagram,
  authorData.socialLinks?.twitter,
  authorData.socialLinks?.wikipedia,
].filter(Boolean) as string[];
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  author={authorData.name}
  publishedDate={publishedDate}
  updatedDate={updatedDate}
  keywords={keywords}
>
  <Fragment slot="head">
    <ArticleSchema
      title={title}
      description={description}
      author={{
        name: authorData.name,
        jobTitle: authorData.credentials[0],
        description: credentialsStr,
        sameAs,
      }}
      publishedDate={publishedDate}
      updatedDate={updatedDate}
      keywords={keywords}
      canonical={canonical}
    />
    {faqs.length > 0 && <FAQSchema faqs={faqs} />}
  </Fragment>

  <Header />
  <Breadcrumb items={breadcrumbs} />

  <!-- Hero Section -->
  <header class="hero-section px-3 py-6 pb-4 relative" style="background: var(--gradient-dark);">
    <div class="container-article">
      {programBadge && (
        <span class="inline-block px-2 py-1 rounded-full font-mono text-label uppercase tracking-widest mb-2" style="background-color: var(--accent-primary); color: var(--bg-primary);">
          {programBadge}
        </span>
      )}

      <h1 class="font-bebas text-display-lg leading-tight mb-2" style="color: var(--text-primary);">
        {title}
      </h1>

      <div class="flex flex-wrap items-center gap-1.5 text-body-xs mb-4" style="color: var(--text-muted);">
        <time datetime={updatedDate.toISOString()}>
          {updatedDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
        </time>
        <span class="opacity-40">·</span>
        <span>{readTime}</span>
        <span class="opacity-40">·</span>
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
          Expert Verified
        </span>
      </div>

      <!-- Direct Answer -->
      <DirectAnswer>
        <p set:html={directAnswer} />
      </DirectAnswer>

      <!-- Key Takeaways -->
      <KeyTakeaways takeaways={keyTakeaways} />

      <!-- Expert Box -->
      <ExpertBox
        name={authorData.name}
        initials={authorData.initials}
        tagline={authorData.tagline}
        credentials={credentialsStr}
        image={authorData.image}
        profileUrl={authorData.profileUrl}
        socialLinks={authorData.socialLinks}
      />
    </div>
  </header>

  <!-- Table of Contents -->
  {toc.length > 0 && (
    <div class="container-article">
      <nav class="toc-nav my-4" aria-label="Table of Contents">
        <div class="toc-header">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/></svg>
          <span>In This Guide</span>
        </div>
        <ol class="toc-list">
          {toc.map((item, i) => (
            <li>
              <a href={`#${item.id}`} class="toc-link">
                <span class="toc-num">{String(i + 1).padStart(2, '0')}</span>
                <span>{item.label}</span>
              </a>
            </li>
          ))}
        </ol>
      </nav>
    </div>
  )}

  <!-- Main Content -->
  <main class="py-4">
    <div class="container-article prose prose-lg max-w-none">
      <slot />
    </div>
  </main>

  <Footer />
</BaseLayout>
