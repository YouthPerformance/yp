import { useCallback, useEffect, useRef, useState } from "react";
import "./LP.css";
import { track, EVENTS } from "../lib/analytics";

console.log("[LP] Module loaded");

// CTA A/B Test Variants (PostHog flag: hero-cta-test)
const CTA_CONFIG = {
  athlete: { text: "FREE ATHLETE ASSESSMENT", subtext: "Personalized evaluation for young athletes" },
  start: { text: "START FREE ASSESSMENT", subtext: "Takes 2 minutes • 100% free" },
  outcome: { text: "GET BULLETPROOF ANKLES", subtext: "Free training plan for injury prevention" },
};

const PLAYBOOK_URL = "https://playbook.youthperformance.com/barefoot-training/injury-rehab/bulletproof-ankles";

// =============================================================================
// AWARD-WINNING LP - 2026 EDITION
// Effects: Magnetic cursor, spotlight, text scramble, confetti, sound design
// =============================================================================

// Text scramble characters
const CHARS = "!<>-_\\/[]{}—=+*^?#________";

// Scramble text effect
function useTextScramble(text, trigger) {
  const [displayText, setDisplayText] = useState("");
  const [isComplete, setIsComplete] = useState(false);

  useEffect(() => {
    if (!trigger) return;

    let iteration = 0;
    const maxIterations = text.length * 3;

    const interval = setInterval(() => {
      setDisplayText(
        text
          .split("")
          .map((char, index) => {
            if (index < iteration / 3) return text[index];
            if (char === " ") return " ";
            return CHARS[Math.floor(Math.random() * CHARS.length)];
          })
          .join(""),
      );

      iteration++;
      if (iteration >= maxIterations) {
        clearInterval(interval);
        setDisplayText(text);
        setIsComplete(true);
      }
    }, 30);

    return () => clearInterval(interval);
  }, [text, trigger]);

  return { displayText, isComplete };
}

// Counter animation hook
function useCountUp(end, duration = 2000, trigger) {
  const [count, setCount] = useState(0);

  useEffect(() => {
    if (!trigger) return;

    let startTime;
    const animate = (timestamp) => {
      if (!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime) / duration, 1);
      const eased = 1 - (1 - progress) ** 4; // easeOutQuart
      setCount(Math.floor(eased * end));
      if (progress < 1) requestAnimationFrame(animate);
    };
    requestAnimationFrame(animate);
  }, [end, duration, trigger]);

  return count;
}

// Confetti particle
function Confetti({ x, y, color, delay }) {
  return (
    <div
      className="confetti-particle"
      style={{
        left: x,
        top: y,
        background: color,
        animationDelay: `${delay}ms`,
      }}
    />
  );
}

export default function LP() {
  console.log("[LP] Component rendering");
  // Refs
  const containerRef = useRef(null);
  const logoRef = useRef(null);
  const ctaRef = useRef(null);

  // State
  const [mousePos, setMousePos] = useState({ x: 0.5, y: 0.5 });
  const [cursorPos, setCursorPos] = useState({ x: 0, y: 0 });
  const [isReady, setIsReady] = useState(true); // No fake loader - show content immediately
  const [glitchActive, setGlitchActive] = useState(false);
  const [soundEnabled, setSoundEnabled] = useState(false);
  const [confetti, setConfetti] = useState([]);
  const [magneticOffset, setMagneticOffset] = useState({ x: 0, y: 0 });
  const [konamiProgress, setKonamiProgress] = useState(0);
  const [easterEggActive, setEasterEggActive] = useState(false);
  const [cursorScale, setCursorScale] = useState(1);
  const [cursorText, setCursorText] = useState("");
  const [ctaVariant, setCtaVariant] = useState("outcome");

  // Text scramble for taglines
  const { displayText: line1, isComplete: line1Complete } = useTextScramble(
    "ELITE TRAINING",
    isReady,
  );
  const { displayText: line2 } = useTextScramble("FOR EVERY KID", line1Complete);

  // Counter animations
  const athleteCount = useCountUp(10000, 2500, isReady);
  const countryCount = useCountUp(47, 2000, isReady);

  // Konami code: ↑↑↓↓←→←→BA
  const konamiCode = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65];


  // Load Unicorn Studio script
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://cdn.unicorn.studio/v1.3.2/unicornStudio.umd.js';
    script.async = true;
    script.onload = () => {
      if (window.UnicornStudio) {
        window.UnicornStudio.init();
      }
    };
    document.body.appendChild(script);

    return () => {
      document.body.removeChild(script);
    };
  }, []);

  // Mouse tracking for parallax and spotlight
  useEffect(() => {
    const handleMouseMove = (e) => {
      const x = e.clientX / window.innerWidth;
      const y = e.clientY / window.innerHeight;
      setMousePos({ x, y });
      setCursorPos({ x: e.clientX, y: e.clientY });

      // Magnetic effect for CTA button
      if (ctaRef.current) {
        const rect = ctaRef.current.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const distX = e.clientX - centerX;
        const distY = e.clientY - centerY;
        const distance = Math.sqrt(distX * distX + distY * distY);

        if (distance < 150) {
          const force = (150 - distance) / 150;
          setMagneticOffset({
            x: distX * force * 0.3,
            y: distY * force * 0.3,
          });
        } else {
          setMagneticOffset({ x: 0, y: 0 });
        }
      }
    };

    window.addEventListener("mousemove", handleMouseMove);
    return () => window.removeEventListener("mousemove", handleMouseMove);
  }, []);

  // Konami code detection
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.keyCode === konamiCode[konamiProgress]) {
        const newProgress = konamiProgress + 1;
        setKonamiProgress(newProgress);
        if (newProgress === konamiCode.length) {
          setEasterEggActive(true);
          playSound("success");
          triggerConfetti(window.innerWidth / 2, window.innerHeight / 2, 50);
          setTimeout(() => setKonamiProgress(0), 1000);
        }
      } else {
        setKonamiProgress(0);
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [konamiProgress]);

  // Random glitch effect
  useEffect(() => {
    if (!isReady) return;
    const glitchInterval = setInterval(() => {
      if (Math.random() > 0.9) {
        setGlitchActive(true);
        setTimeout(() => setGlitchActive(false), 150);
      }
    }, 3000);
    return () => clearInterval(glitchInterval);
  }, [isReady]);

  // PostHog A/B test for CTA
  useEffect(() => {
    if (typeof window !== "undefined" && typeof window.posthog !== "undefined") {
      const variant = window.posthog.getFeatureFlag("hero-cta-test");
      if (variant && CTA_CONFIG[variant]) {
        setCtaVariant(variant);
      }
    }
  }, []);

  // Sound effects (requires user interaction to enable)
  const playSound = useCallback(
    (type) => {
      if (!soundEnabled) return;

      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      switch (type) {
        case "hover":
          oscillator.frequency.value = 800;
          gainNode.gain.value = 0.05;
          oscillator.start();
          oscillator.stop(audioContext.currentTime + 0.05);
          break;
        case "click":
          oscillator.frequency.value = 600;
          gainNode.gain.value = 0.1;
          oscillator.start();
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          oscillator.stop(audioContext.currentTime + 0.1);
          break;
        case "success":
          oscillator.frequency.value = 523.25; // C5
          gainNode.gain.value = 0.1;
          oscillator.start();
          oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
          oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
          oscillator.stop(audioContext.currentTime + 0.3);
          break;
        default:
          break;
      }
    },
    [soundEnabled],
  );

  // Confetti explosion
  const triggerConfetti = (x, y, count = 30) => {
    const colors = ["#00f6e0", "#8a2be2", "#00bfff", "#ff6b6b", "#ffd93d"];
    const particles = [];

    for (let i = 0; i < count; i++) {
      particles.push({
        id: Date.now() + i,
        x: x + (Math.random() - 0.5) * 20,
        y: y + (Math.random() - 0.5) * 20,
        color: colors[Math.floor(Math.random() * colors.length)],
        delay: Math.random() * 100,
      });
    }

    setConfetti(particles);
    setTimeout(() => setConfetti([]), 2000);
  };

  // CTA click handler
  const handleCTAClick = (e) => {
    e.preventDefault();
    playSound("click");

    // Track A/B variant click
    track(EVENTS.CTA_CLICK, {
      variant: ctaVariant,
      destination: "playbook_bulletproof_ankles",
    });

    const rect = e.currentTarget.getBoundingClientRect();
    triggerConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2, 40);

    // Navigate to playbook after animation
    setTimeout(() => {
      window.location.href = PLAYBOOK_URL;
    }, 800);
  };

  // Cursor handlers
  const handleCursorEnter = (text, scale = 1.5) => {
    setCursorText(text);
    setCursorScale(scale);
    playSound("hover");
  };

  const handleCursorLeave = () => {
    setCursorText("");
    setCursorScale(1);
  };

  // Parallax values
  const parallaxX = (mousePos.x - 0.5) * 30;
  const parallaxY = (mousePos.y - 0.5) * 30;
  const rotateX = (mousePos.y - 0.5) * -15;
  const rotateY = (mousePos.x - 0.5) * 15;

  // =============================================================================
  // RENDER
  // =============================================================================

  return (
    <div
      ref={containerRef}
      className={`lp-container ${isReady ? "ready" : ""} ${easterEggActive ? "rainbow-mode" : ""}`}
    >
      {/* Custom Cursor */}
      <div
        className="lp-cursor"
        style={{
          left: cursorPos.x,
          top: cursorPos.y,
          transform: `translate(-50%, -50%) scale(${cursorScale})`,
        }}
      >
        <div className="lp-cursor-dot" />
        <div className="lp-cursor-ring" />
        {cursorText && <span className="lp-cursor-text">{cursorText}</span>}
      </div>

      {/* Cursor Trail */}
      <div
        className="lp-cursor-glow"
        style={{
          left: cursorPos.x,
          top: cursorPos.y,
        }}
      />

      {/* Spotlight Effect */}
      <div
        className="lp-spotlight"
        style={{
          background: `radial-gradient(600px circle at ${cursorPos.x}px ${cursorPos.y}px, rgba(0, 246, 224, 0.06), transparent 40%)`,
        }}
      />

      {/* =========== MAIN CONTENT =========== */}
      <div className={`lp-main-wrapper ${isReady ? "visible" : ""}`}>
        {/* Noise & Effects */}
        <div className="lp-noise" />
        <div className="lp-scanlines" />
        <div className="lp-vignette" />

        {/* Animated Gradient Mesh */}
        <div className="lp-gradient-mesh" />

        {/* Floating Particles */}
        <div className="lp-particles">
          {[...Array(40)].map((_, i) => (
            <div
              key={i}
              className="lp-particle"
              style={{
                left: `${Math.random() * 100}%`,
                animationDelay: `${Math.random() * 20}s`,
                animationDuration: `${15 + Math.random() * 20}s`,
                opacity: 0.3 + Math.random() * 0.5,
              }}
            />
          ))}
        </div>

        {/* Ambient Glow Orbs */}
        <div
          className="lp-orb lp-orb-1"
          style={{
            transform: `translate(${parallaxX * 2}px, ${parallaxY * 2}px)`,
          }}
        />
        <div
          className="lp-orb lp-orb-2"
          style={{
            transform: `translate(${-parallaxX * 1.5}px, ${-parallaxY * 1.5}px)`,
          }}
        />
        <div
          className="lp-orb lp-orb-3"
          style={{
            transform: `translate(${parallaxX}px, ${-parallaxY}px)`,
          }}
        />

        {/* Sound Toggle */}
        <button
          className={`lp-sound-toggle ${soundEnabled ? "active" : ""}`}
          onClick={() => {
            setSoundEnabled(!soundEnabled);
            if (!soundEnabled) playSound("click");
          }}
          onMouseEnter={() => handleCursorEnter("SOUND", 1.2)}
          onMouseLeave={handleCursorLeave}
          aria-label="Toggle sound"
        >
          {soundEnabled ? (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M11 5L6 9H2v6h4l5 4V5z" />
              <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
            </svg>
          ) : (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M11 5L6 9H2v6h4l5 4V5z" />
              <line x1="23" y1="9" x2="17" y2="15" />
              <line x1="17" y1="9" x2="23" y2="15" />
            </svg>
          )}
        </button>

        {/* Main Content */}
        <main className="lp-main">
          {/* 3D Logo - Unicorn Studio */}
          <div
            ref={logoRef}
            className={`lp-unicorn-container ${glitchActive ? "glitch" : ""}`}
            onMouseEnter={() => handleCursorEnter("", 2)}
            onMouseLeave={handleCursorLeave}
          >
            <div
              data-us-project="naRSjPpjqWS37meInh9T"
              style={{ width: '100%', height: '100%' }}
            />
          </div>

          {/* Tagline with Scramble Effect */}
          <h1 className="lp-tagline">
            <span className="lp-tagline-line">{displayText || "\u00A0"}</span>
            <span className="lp-tagline-accent">{line2 || "\u00A0"}</span>
          </h1>

          {/* Stats Counter */}
          <div className="lp-stats">
            <div className="lp-stat">
              <span className="lp-stat-number">{athleteCount.toLocaleString()}+</span>
              <span className="lp-stat-label">ATHLETES</span>
            </div>
            <div className="lp-stat-divider" />
            <div className="lp-stat">
              <span className="lp-stat-number">{countryCount}</span>
              <span className="lp-stat-label">COUNTRIES</span>
            </div>
          </div>

          {/* Magnetic CTA Button */}
          <a
            ref={ctaRef}
            href={PLAYBOOK_URL}
            className="lp-cta"
            onClick={handleCTAClick}
            onMouseEnter={() => handleCursorEnter("", 0)}
            onMouseLeave={handleCursorLeave}
            style={{
              transform: `translate(${magneticOffset.x}px, ${magneticOffset.y}px)`,
            }}
          >
            <span className="lp-cta-bg" />
            <span className="lp-cta-text">{CTA_CONFIG[ctaVariant].text}</span>
            <span className="lp-cta-arrow">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M5 12h14M12 5l7 7-7 7" />
              </svg>
            </span>
            <span className="lp-cta-shine" />
          </a>

          {/* Social Proof Ticker */}
          <div className="lp-ticker-container">
            <div className="lp-ticker">
              <div className="lp-ticker-content">
                {[...Array(2)].map((_, i) => (
                  <div key={i} className="lp-ticker-items">
                    <span className="lp-ticker-item">
                      <span className="lp-ticker-dot" /> NBA SKILLS COACH APPROVED
                    </span>
                    <span className="lp-ticker-item">
                      <span className="lp-ticker-dot" /> USED BY D1 PROGRAMS
                    </span>
                    <span className="lp-ticker-item">
                      <span className="lp-ticker-dot" /> AI-POWERED TRAINING
                    </span>
                    <span className="lp-ticker-item">
                      <span className="lp-ticker-dot" /> BUILD SPRINGS NOT PISTONS
                    </span>
                    <span className="lp-ticker-item">
                      <span className="lp-ticker-dot" /> YOUTH PERFORMANCE
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Scroll Indicator */}
          <div className="lp-scroll-indicator">
            <div className="lp-scroll-line" />
            <span>SCROLL TO EXPLORE</span>
          </div>
        </main>

        {/* Confetti Container */}
        <div className="lp-confetti-container">
          {confetti.map((particle) => (
            <Confetti key={particle.id} {...particle} />
          ))}
        </div>

        {/* Bottom Fade */}
        <div className="lp-bottom-fade" />
      </div>
    </div>
  );
}
