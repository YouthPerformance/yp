---
/**
 * Analytics Component - PostHog Only
 *
 * AI-native, privacy-first analytics.
 * No cookies = no consent banner needed (CCPA compliant for US).
 */

interface Props {
  posthogKey?: string;
  posthogHost?: string;
}

const {
  posthogKey = import.meta.env.PUBLIC_POSTHOG_KEY || "phc_lcgYo2g4YNIqVcK1d75227vPTROVvlbVBaj9rBxnfvJ",
  posthogHost = import.meta.env.PUBLIC_POSTHOG_HOST || "https://us.i.posthog.com",
} = Astro.props;

const isProd = import.meta.env.PROD;
---

{/* PostHog - deferred initialization, privacy-first */}
{posthogKey && (
  <script is:inline define:vars={{ posthogKey, posthogHost, isProd }}>
    // Check for opt-out before initializing
    if (localStorage.getItem('yp_opted_out') !== 'true') {
      // Defer PostHog init to after page load for better LCP
      window.addEventListener('load', function() {
        setTimeout(function() {
          !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group setPersonProperties setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);

          posthog.init(posthogKey, {
            api_host: posthogHost,

            // Privacy-first (no cookies = no consent banner)
            persistence: 'localStorage',
            person_profiles: 'identified_only',
            respect_dnt: true,

            // AI-native (let autocapture do the work)
            autocapture: true,
            capture_pageview: true,
            capture_pageleave: true,

            // Session recording with privacy
            disable_session_recording: !isProd,
            session_recording: {
              maskAllInputs: true,
              maskTextSelector: '[data-mask]'
            },

            // Feature flags
            advanced_disable_decide: false,

            loaded: function(posthog) {
              if (!isProd) {
                posthog.debug();
              }
            }
          });
        }, 100); // Small delay to prioritize LCP
      });
    }
  </script>
)}
