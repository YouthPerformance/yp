---
// This page is server-rendered to handle dynamic referral codes
export const prerender = false;

const { code } = Astro.params;
---

<Layout title="Join the NeoBall Waitlist">
  <!-- Referral Landing Page -->
  <section class="min-h-screen flex items-center justify-center px-4 py-16">
    <div class="max-w-lg w-full">
      <!-- Card -->
      <div class="bg-surface rounded-2xl border border-white/10 overflow-hidden">
        <!-- Header -->
        <div class="p-8 text-center border-b border-white/5">
          <div class="mb-4">
            <span class="text-6xl">üèÄ</span>
          </div>
          <h1 class="font-display text-4xl tracking-wider">
            <span class="text-cyan">NEO</span>BALL
          </h1>
          <p class="mt-2 text-gray-400">
            World's Best Silent Basketball
          </p>
        </div>

        <!-- Referral message -->
        <div class="p-6 bg-gradient-to-r from-pink/10 to-transparent">
          <p class="text-center text-sm text-gray-300">
            Your friend invited you to join the waitlist!
          </p>
        </div>

        <!-- Features mini -->
        <div class="p-6 space-y-4">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-cyan/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <span class="text-gray-300 text-sm">Truly silent - train anywhere</span>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-cyan/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <span class="text-gray-300 text-sm">Real game feel and weight</span>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-cyan/10 flex items-center justify-center">
              <svg class="w-4 h-4 text-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <span class="text-gray-300 text-sm">Join thousands of young athletes</span>
          </div>
        </div>

        <!-- CTA -->
        <div class="p-6">
          <button
            id="join-btn"
            class="w-full py-4 bg-pink text-white font-bold text-lg rounded-lg glow-pink hover:bg-cyan hover:text-wolf-black transition-all"
          >
            JOIN THE WAITLIST
          </button>
          <p class="text-center text-gray-600 text-xs mt-3 font-mono">
            Be notified when NeoBall is back in stock
          </p>
        </div>
      </div>

      <!-- Back to home link -->
      <p class="text-center mt-6">
        <a href="/" class="text-gray-500 hover:text-cyan text-sm transition-colors">
          ‚Üê Learn more about NeoBall
        </a>
      </p>
    </div>
  </section>

  <!-- Waitlist Modal (React component) -->
  <div id="modal-root"></div>
</Layout>

<script define:vars={{ code }}>
  // Store referrer code for the modal
  window.__REFERRER_CODE__ = code;

  // Handle join button click
  document.getElementById('join-btn')?.addEventListener('click', () => {
    // Dispatch custom event to open modal
    window.dispatchEvent(new CustomEvent('open-waitlist-modal', {
      detail: { referrerCode: code }
    }));
  });
</script>

<script>
  import { createRoot } from 'react-dom/client';
  import { createElement } from 'react';
  import { ConvexProvider, ConvexReactClient } from 'convex/react';
  import WaitlistModal from '../../components/WaitlistModal';

  // Initialize Convex client
  const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;
  if (convexUrl) {
    const convex = new ConvexReactClient(convexUrl);

    // Create modal root
    const modalRoot = document.getElementById('modal-root');
    if (modalRoot) {
      const root = createRoot(modalRoot);

      // App component with state
      let isOpen = false;
      const referrerCode = (window as any).__REFERRER_CODE__;

      function render() {
        root.render(
          createElement(
            ConvexProvider,
            { client: convex },
            createElement(WaitlistModal, {
              isOpen,
              onClose: () => {
                isOpen = false;
                render();
              },
              referrerCode,
            })
          )
        );
      }

      // Listen for open event
      window.addEventListener('open-waitlist-modal', () => {
        isOpen = true;
        render();
      });

      // Initial render
      render();

      // Auto-open modal on referral page
      setTimeout(() => {
        isOpen = true;
        render();
      }, 500);
    }
  }
</script>
